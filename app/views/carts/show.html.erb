<% valid_items = @cart.items.select { |item| item.quantity.present? && item.quantity > 0 } %>

<h1>Mon panier</h1>

<% if @cart.status == "new" %>
  <% if valid_items.any? %>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
      <% valid_items.each do |item| %>
        <div style="border: 1px solid #ccc; padding: 1rem; border-radius: 8px;">
          <% if item.product.image_url.present? %>
            <%= image_tag item.product.image_url, alt: item.product.name, style: "width: 100%; height: auto;" %>
          <% end %>

          <div>
            <h2><%= item.product.name %></h2>
            <p>Quantit√© : <%= item.quantity %></p>
            <p>Prix unitaire : <%= number_to_currency(item.product.price) %></p>
          </div>

          <div style="display: flex; gap: 0.5rem; margin: 0.5rem 0;">
            <% if item.quantity > 1 %>
              <%= form_with model: item, url: item_path(item), method: :patch, local: true do |form| %>
                <%= form.hidden_field :quantity, value: item.quantity - 1 %>
                <%= form.submit "-", class: "btn" %>
              <% end %>
            <% end %>

            <%= form_with model: item, url: item_path(item), method: :patch, local: true do |form| %>
              <%= form.hidden_field :quantity, value: item.quantity + 1 %>
              <%= form.submit "+", class: "btn" %>
            <% end %>
          </div>

          <div>
            <%= button_to "Supprimer", item_path(item), method: :delete, data: { confirm: "Supprimer cet article ?" }, class: "btn btn-danger" %>
          </div>
        </div>
      <% end %>
    </div>

    <div style="margin-top: 2rem;">
      <p><strong>Total :</strong> <%= number_to_currency(@cart.total_price) %></p>
      <div style="display: flex; gap: 1rem;">
        <%= button_to "Commander",
            cart_path(@cart),
            method: :patch,
            params: { cart: { status: "confirmed" } },
            data: { confirm: "Confirmer la commande ?" },
            class: "btn btn-primary"
        %>
        <%= button_to "Vider le panier",
            cart_path(@cart),
            method: :delete,
            data: { confirm: "Vider le panier ?" },
            class: "btn btn-warning"
        %>
      </div>
    </div>
  <% else %>
    <p>Votre panier est vide.</p>
  <% end %>
<% else %>
  <p>Votre panier est vide.</p>
<% end %>
